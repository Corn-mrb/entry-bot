<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ store_name }} - ì²´í¬ì¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #e9ecff;
        }

        .container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 420px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .store-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .store-name {
            color: #fff;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-bottom: 24px;
        }

        .status-text b.ok { color: #3ddc84; }
        .status-text b.bad { color: #ff5a5a; }

        .btn {
            display: block;
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #5865F2 0%, #4752C4 100%);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(88, 101, 242, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-success {
            background: linear-gradient(135deg, #43B581 0%, #3CA374 100%);
            color: #fff;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(67, 181, 129, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.big {
            padding: 18px 24px;
            font-size: 18px;
            border-radius: 14px;
        }

        .user-info {
            background: rgba(67, 181, 129, 0.1);
            border: 1px solid rgba(67, 181, 129, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #43B581;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
        }

        .passphrase-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 16px;
            margin-bottom: 12px;
            outline: none;
        }

        .passphrase-input:focus {
            border-color: #5865F2;
        }

        .passphrase-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .error-message {
            background: rgba(237, 66, 69, 0.1);
            border: 1px solid rgba(237, 66, 69, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #ED4245;
        }

        .success-message {
            background: rgba(67, 181, 129, 0.1);
            border: 1px solid rgba(67, 181, 129, 0.3);
            border-radius: 10px;
            padding: 20px;
            color: #43B581;
        }

        .success-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .logout-link {
            display: inline-block;
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 13px;
            text-decoration: none;
        }

        .logout-link:hover {
            color: rgba(255, 255, 255, 0.8);
        }

        .note {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            margin-top: 15px;
            line-height: 1.5;
        }

        #passphrase-section {
            display: none;
        }

        #result-section {
            display: none;
        }

        .hidden {
            display: none !important;
        }

        /* Modal */
        .backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 50;
        }

        .modal {
            width: min(480px, 100%);
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal h2 {
            margin: 0 0 12px;
            font-size: 20px;
            color: #fff;
        }

        .modal p {
            margin: 0 0 16px;
            opacity: 0.85;
            line-height: 1.5;
            font-size: 14px;
        }

        .in-app-warn {
            padding: 12px;
            border-radius: 10px;
            background: rgba(255, 90, 90, 0.1);
            border: 1px solid rgba(255, 90, 90, 0.3);
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
            color: #ff5a5a;
        }

        .security-risk {
            padding: 12px;
            border-radius: 10px;
            background: rgba(255, 180, 0, 0.08);
            border: 1px solid rgba(255, 180, 0, 0.25);
            font-size: 12px;
            margin: 16px 0;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }

        .security-risk b {
            color: #ffb400;
        }

        .modal-actions {
            margin-top: 16px;
        }

        .mini-btns {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .mini-btns .btn {
            flex: 1;
            padding: 12px;
            font-size: 13px;
            margin-bottom: 0;
        }

        .modal-row {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .modal-row .btn {
            flex: 1;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="store-icon">ğŸª</div>
        <h1 class="store-name">{{ store_name }}</h1>

        {% if not store_exists %}
        <div class="error-message">
            ë“±ë¡ë˜ì§€ ì•Šì€ ì¥ì†Œì…ë‹ˆë‹¤.
        </div>
        {% elif not is_logged_in %}
        <!-- ë¡œê·¸ì¸ ì „ -->
        <p class="status-text">ìƒíƒœ: <b class="bad">ë¡œê·¸ì¸ í•„ìš”</b></p>

        <button id="login-btn" class="btn btn-primary big">Discordë¡œ ì²´í¬ì¸</button>

        <p class="note">* ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë¡œê·¸ì¸ ë°©ì‹ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        {% else %}
        <!-- ë¡œê·¸ì¸ í›„ -->
        <p class="status-text">ìƒíƒœ: <b class="ok">ë¡œê·¸ì¸ ì™„ë£Œ</b></p>

        <div id="checkin-section">
            <div class="user-info">
                <div class="user-name">{{ user.global_name or user.username }}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</div>
            </div>

            <div id="error-box" class="error-message hidden"></div>

            <div id="passphrase-section">
                <input type="password" id="passphrase-input" class="passphrase-input" placeholder="ì•”êµ¬í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <button id="checkin-btn" class="btn btn-success big">ì²´í¬ì¸í•˜ê¸°</button>

            <a href="/logout" class="logout-link">ë¡œê·¸ì•„ì›ƒ</a>
        </div>

        <div id="result-section">
            <div class="success-message">
                <div class="success-icon">âœ…</div>
                <div id="result-message"></div>
            </div>
            <a href="/logout" class="logout-link">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
        {% endif %}
    </div>

    <!-- Login Modal -->
    <div class="backdrop" id="login-modal" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true">
            <h2>Discord ë¡œê·¸ì¸</h2>
            <p>APPì— ë¡œê·¸ì¸ë˜ì–´ ìˆë‹¤ë©´, APPì—ì„œ ë°”ë¡œ ìŠ¹ì¸ í™”ë©´ìœ¼ë¡œ ë„˜ì–´ê°ˆ ìˆ˜ ìˆì–´ìš”.</p>

            <div class="in-app-warn" id="in-app-warn">
                í˜„ì¬ <b>ì¸ì•± ë¸Œë¼ìš°ì €</b>ë¡œ ì—´ë ¤ìˆì„ ê°€ëŠ¥ì„±ì´ ìˆì–´ìš”. ì´ í™˜ê²½ì—ì„œëŠ” APP ì „í™˜ì´ ë§‰í ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                ê°€ëŠ¥í•˜ë©´ ìš°ì¸¡ ìƒë‹¨ ë©”ë‰´ì—ì„œ <b>ê¸°ë³¸ ë¸Œë¼ìš°ì €(Chrome/Safari)ë¡œ ì—´ê¸°</b>ë¡œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
            </div>

            <div class="modal-actions">
                <button id="app-login-btn" class="btn btn-primary big">APPìœ¼ë¡œ ë¡œê·¸ì¸ í•˜ê¸°</button>

                <div class="security-risk">
                    <b>ì‚¬ì „ ì„¤ëª…</b><br>
                    1. web ë¡œê·¸ì¸ì‹œ, ë””ìŠ¤ì½”ë“œ ê³„ì •ì— ëŒ€í•œ ë³´ì•ˆì— ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë©° ì´ì— ë™ì˜í•˜ê³  ì¸ì§€í•©ë‹ˆë‹¤.<br>
                    2. web ë¡œê·¸ì¸ í›„ ë°˜ë“œì‹œ Discord ê³„ì •ì„ webì—ì„œ ë¡œê·¸ì•„ì›ƒ í•´ì•¼í•˜ë©° ì´ì— ë™ì˜í•˜ê³  ì¸ì§€í•©ë‹ˆë‹¤. (í•´ë‹¹ ë´‡ ë¡œê·¸ì•„ì›ƒì´ ì•„ë‹Œ Discord ìì²´ ë¡œê·¸ì•„ì›ƒ)<br>
                    3. web ë¡œê·¸ì¸ í›„ Discord ê³„ì •ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í• ê²ƒì„ ê¶Œì¥í•˜ë©° ì´ì— ë™ì˜í•˜ê³  ì¸ì§€í•©ë‹ˆë‹¤.<br>
                    4. web ë¡œê·¸ì¸ì‹œ ë°œìƒí•˜ëŠ” ë¬¸ì œì— ëŒ€í•œ ì±…ì„ì€ í•´ë‹¹ ë´‡ ì‚¬ìš©ìì—ê²Œ ìˆìŒì„ ë™ì˜í•˜ê³  ì¸ì§€í•©ë‹ˆë‹¤.
                </div>

                <div class="mini-btns">
                    <button id="open-discord-btn" class="btn btn-secondary">Discord APP ë¨¼ì € ì—´ê¸°</button>
                    <button id="web-login-btn" class="btn btn-secondary">WEBìœ¼ë¡œ ë¡œê·¸ì¸ í•˜ê¸°</button>
                </div>

                <p class="note">* APPìœ¼ë¡œ ë¡œê·¸ì¸ í•˜ê¸°ë¥¼ ëˆŒë €ì„ë•Œ WEB ë¡œê·¸ì¸ì°½ìœ¼ë¡œ ì—°ë™ë˜ëŠ” ê²½ìš°ê°€ ë°œìƒ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•´ë‹¹ ê²½ìš°ì— WEBì—ì„œ ë¡œê·¸ì¸ì„ ì§„í–‰í•  ì‹œ ë´‡ì— ì‚¬ì „ ì„¤ëª…ì„ ë™ì˜í•˜ë©° ì¸ì§€í•˜ê³  ìˆëŠ”ê²ƒìœ¼ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.</p>
            </div>

            <div class="modal-row">
                <button id="close-modal-btn" class="btn btn-secondary">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë³€ìˆ˜ë“¤
        const LOC = {{ loc | tojson | safe }};
        const OAUTH_URL = {{ oauth_url | tojson | safe }};
        const DISCORD_AUTHORIZE_URL = {{ discord_authorize_url | tojson | safe }};
        const IS_LOGGED_IN = {{ 'true' if is_logged_in else 'false' }};

        // ë””ë°”ì´ìŠ¤ ê°ì§€
        function isAndroid() {
            return /Android/i.test(navigator.userAgent);
        }

        function isIOS() {
            return /iPhone|iPad|iPod/i.test(navigator.userAgent);
        }

        function isInAppBrowser() {
            const ua = navigator.userAgent || "";
            return /KAKAOTALK|Instagram|FBAN|FBAV|Line\//i.test(ua) || /NAVER\(inapp\)/i.test(ua);
        }

        // Android Intent URL ìƒì„±
        function buildAndroidIntentUrl(webUrl) {
            try {
                const u = new URL(webUrl, window.location.origin);
                const fallback = encodeURIComponent(webUrl);
                return `intent://${u.host}${u.pathname}${u.search}#Intent;scheme=${u.protocol.replace(':','')};package=com.discord;S.browser_fallback_url=${fallback};end`;
            } catch (e) {
                return "";
            }
        }

        // Discord Scheme URL ìƒì„± (iOS)
        function buildDiscordSchemeUrl(webUrl) {
            try {
                const u = new URL(webUrl, window.location.origin);
                if (/^discord\.com$/i.test(u.hostname) && u.pathname.startsWith("/oauth2/authorize")) {
                    return `discord://-/oauth2/authorize${u.search}`;
                }
                return u.toString().replace(/^https?:\/\//i, "discord://");
            } catch (e) {
                return "";
            }
        }

        // Discord ì•± ì—´ê¸° URL
        function buildDiscordAppOpenUrl() {
            if (isAndroid()) {
                return "intent://discord.com/app#Intent;scheme=https;package=com.discord;end";
            }
            return "discord://";
        }

        // Fallbackì„ í¬í•¨í•œ URL ì—´ê¸°
        function openWithFallback(primaryUrl, fallbackUrl) {
            const startedAt = Date.now();
            let didHide = false;

            const onHide = () => { didHide = true; };
            document.addEventListener("visibilitychange", onHide, { once: true });
            window.addEventListener("pagehide", onHide, { once: true });

            window.location.href = primaryUrl;

            setTimeout(() => {
                const stillVisible = document.visibilityState !== "hidden" && !didHide;
                const elapsed = Date.now() - startedAt;
                if (stillVisible && elapsed >= 900) {
                    window.location.href = fallbackUrl;
                }
            }, 950);
        }

        // APPìœ¼ë¡œ Discord OAuth ì—´ê¸°
        function openDiscordOAuthInApp() {
            const web = DISCORD_AUTHORIZE_URL || (new URL(OAUTH_URL, window.location.origin).toString());
            const fallback = OAUTH_URL;

            // PCì¸ ê²½ìš° ë°”ë¡œ ì›¹ìœ¼ë¡œ
            if (!isAndroid() && !isIOS()) {
                window.location.href = fallback;
                return;
            }

            // Android Intent
            if (isAndroid()) {
                const intent = buildAndroidIntentUrl(web);
                if (intent) {
                    openWithFallback(intent, fallback);
                    return;
                }
            }

            // iOS Scheme
            const scheme = buildDiscordSchemeUrl(web);
            if (scheme) {
                openWithFallback(scheme, fallback);
            } else {
                window.location.href = fallback;
            }
        }

        // Discord ì•± ì—´ê¸°
        function openDiscordApp() {
            window.location.href = buildDiscordAppOpenUrl();
        }

        // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        function openModal() {
            const modal = document.getElementById('login-modal');
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden', 'false');

            // ì¸ì•± ë¸Œë¼ìš°ì € ê²½ê³  í‘œì‹œ
            document.getElementById('in-app-warn').style.display = isInAppBrowser() ? 'block' : 'none';
        }

        function closeModal() {
            const modal = document.getElementById('login-modal');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.addEventListener('DOMContentLoaded', function() {
            // ë¡œê·¸ì¸ ë²„íŠ¼ (ë¡œê·¸ì¸ ì „)
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', function() {
                    openModal();
                });
            }

            // ëª¨ë‹¬ - APPìœ¼ë¡œ ë¡œê·¸ì¸
            const appLoginBtn = document.getElementById('app-login-btn');
            if (appLoginBtn) {
                appLoginBtn.addEventListener('click', function() {
                    openDiscordOAuthInApp();
                });
            }

            // ëª¨ë‹¬ - WEBìœ¼ë¡œ ë¡œê·¸ì¸
            const webLoginBtn = document.getElementById('web-login-btn');
            if (webLoginBtn) {
                webLoginBtn.addEventListener('click', function() {
                    window.location.href = OAUTH_URL;
                });
            }

            // ëª¨ë‹¬ - Discord ì•± ë¨¼ì € ì—´ê¸°
            const openDiscordBtn = document.getElementById('open-discord-btn');
            if (openDiscordBtn) {
                openDiscordBtn.addEventListener('click', function() {
                    openDiscordApp();
                });
            }

            // ëª¨ë‹¬ ë‹«ê¸°
            const closeModalBtn = document.getElementById('close-modal-btn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeModal);
            }

            // ë°°ê²½ í´ë¦­ì‹œ ëª¨ë‹¬ ë‹«ê¸°
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                loginModal.addEventListener('click', function(e) {
                    if (e.target.id === 'login-modal') {
                        closeModal();
                    }
                });
            }

            // ì²´í¬ì¸ ë²„íŠ¼ (ë¡œê·¸ì¸ í›„)
            const checkinBtn = document.getElementById('checkin-btn');
            if (checkinBtn) {
                checkinBtn.addEventListener('click', doCheckin);
            }
        });

        // ì²´í¬ì¸ ì‹¤í–‰
        let needPassphrase = false;

        async function doCheckin() {
            const btn = document.getElementById('checkin-btn');
            const errorBox = document.getElementById('error-box');
            const passphraseInput = document.getElementById('passphrase-input');

            btn.disabled = true;
            btn.textContent = 'ì²˜ë¦¬ ì¤‘...';
            errorBox.classList.add('hidden');

            const body = { loc: LOC };
            if (needPassphrase && passphraseInput && passphraseInput.value) {
                body.passphrase = passphraseInput.value;
            }

            try {
                const response = await fetch('/api/checkin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                    credentials: 'include'
                });

                // ì„¸ì…˜ ë§Œë£Œ
                if (response.status === 401) {
                    errorBox.textContent = 'ì„¸ì…˜ì´ ë§Œë£Œëì–´ìš”. Discord ë¡œê·¸ì¸ì„ ë‹¤ì‹œ ì§„í–‰í•´ì£¼ì„¸ìš”.';
                    errorBox.classList.remove('hidden');
                    btn.disabled = false;
                    btn.textContent = 'ì²´í¬ì¸í•˜ê¸°';
                    setTimeout(() => {
                        window.location.href = '/logout';
                    }, 2000);
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    // ì„±ê³µ
                    document.getElementById('checkin-section').classList.add('hidden');
                    document.getElementById('result-section').style.display = 'block';

                    let message = data.message;
                    if (data.already_checked_in) {
                        message = 'ì´ë¯¸ ì˜¤ëŠ˜ ì²´í¬ì¸í–ˆìŠµë‹ˆë‹¤!';
                    } else if (data.visit_count) {
                        message += `<br><br>ëˆ„ì  ${data.visit_count}ë²ˆì§¸ ë°©ë¬¸ì…ë‹ˆë‹¤!`;
                    }
                    document.getElementById('result-message').innerHTML = message;
                } else {
                    // ì‹¤íŒ¨
                    if (data.need_passphrase) {
                        // ì•”êµ¬í˜¸ ì…ë ¥ í•„ìš”
                        needPassphrase = true;
                        document.getElementById('passphrase-section').style.display = 'block';
                        if (passphraseInput) passphraseInput.focus();
                        btn.disabled = false;
                        btn.textContent = 'ì²´í¬ì¸í•˜ê¸°';
                    } else {
                        // ì—ëŸ¬ í‘œì‹œ
                        errorBox.textContent = data.message || 'ì²´í¬ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                        errorBox.classList.remove('hidden');
                        btn.disabled = false;
                        btn.textContent = 'ì²´í¬ì¸í•˜ê¸°';
                    }
                }
            } catch (error) {
                errorBox.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                errorBox.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = 'ì²´í¬ì¸í•˜ê¸°';
            }
        }

        // Enter í‚¤ë¡œ ì²´í¬ì¸
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && IS_LOGGED_IN) {
                doCheckin();
            }
        });
    </script>
</body>
</html>
